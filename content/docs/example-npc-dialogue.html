<h1>Example: NPC with Dialogue AI</h1>
<p class="note">Complete working example of an interactive NPC using BaseNPC archetype. Includes dialogue system integration, schedules, idle behaviors, and contextual interactions.</p>

<div class="page-meta">
  <span class="time"><i data-lucide="clock"></i> 25 minutes</span>
  <span class="difficulty"><i data-lucide="code"></i> Example</span>
</div>

<div class="callout tip">
  <span class="icon"><i data-lucide="lightbulb"></i></span>
  <div>
    <strong>What You'll Build:</strong> A town NPC that follows daily schedules, engages in dialogue with players, performs idle activities, reacts to context, and flees from danger. Perfect for RPGs, adventure games, or any game with interactive NPCs.
  </div>
</div>

<h2>Final Result</h2>

<pre><code>NPC AI Behaviors:
├─ Dialogue: Engage with player conversation
├─ Schedule: Follow daily routine (work, eat, sleep)
├─ Idle: Ambient activities when not busy
├─ Wander: Move around local area
├─ Interact: Use objects (sit, craft, etc.)
├─ Flee: Escape from danger
└─ React: Contextual responses to events

Features:
✓ Time-based schedules
✓ Dialogue integration
✓ Context-aware interactions
✓ Idle animation variety
✓ Proximity detection
✓ Flee from threats
✓ Quest integration ready</code></pre>

<h2>Step 1: Create NPC Pawn</h2>

<h3>Blueprint: BP_VillagerNPC</h3>

<pre><code>Parent Class: Character

Components:
  + Skeletal Mesh (villager model)
  + AIPerception
    Senses:
      - AISight (1500 radius, 120° FOV)
      - AIHearing (1000 radius)
      - AIDamage
  + CINQuickSetup
    AgentType: BaseNPC
    bAutoInitialize: true

Variables:
  + CurrentScheduleActivity (EScheduleActivity): Work
  + DialogueComponent (Dialogue Component): nullptr
  + bIsInDialogue (bool): false
  + LastInteractionTime (float): 0.0
  + HomeLocation (FVector): Zero
  + WorkLocation (FVector): Zero
  + IdleLocations (TArray<FVector>): Empty
  + CurrentTime (float): 8.0 // 8 AM start
  
Enums:
  EScheduleActivity:
    - Sleep (0-6 AM)
    - Work (8 AM-5 PM)
    - Eat (12 PM, 6 PM)
    - Socialize (7-10 PM)
    - Idle (other times)</code></pre>

<h2>Step 2: Schedule System</h2>

<h3>Service: UService_NPCSchedule</h3>

<pre><code>// Custom service for time-based scheduling
void UService_NPCSchedule::TickService(float DeltaTime)
{
    Super::TickService(DeltaTime);
    
    ANPCPawn* NPC = GetNPCPawn();
    
    // Update game time (24-hour cycle)
    NPC->CurrentTime += DeltaTime * TimeScale;
    if (NPC->CurrentTime >= 24.0f)
        NPC->CurrentTime = 0.0f;
    
    // Determine current activity based on time
    EScheduleActivity Activity = DetermineActivity(NPC->CurrentTime);
    NPC->CurrentScheduleActivity = Activity;
    
    // Publish schedule inputs
    Brain->SetNamedInputValue(TEXT("Schedule_Sleep"), Activity == EScheduleActivity::Sleep ? 1.0f : 0.0f);
    Brain->SetNamedInputValue(TEXT("Schedule_Work"), Activity == EScheduleActivity::Work ? 1.0f : 0.0f);
    Brain->SetNamedInputValue(TEXT("Schedule_Eat"), Activity == EScheduleActivity::Eat ? 1.0f : 0.0f);
    Brain->SetNamedInputValue(TEXT("Schedule_Socialize"), Activity == EScheduleActivity::Socialize ? 1.0f : 0.0f);
    Brain->SetNamedInputValue(TEXT("Schedule_Idle"), Activity == EScheduleActivity::Idle ? 1.0f : 0.0f);
    
    // Publish time of day
    float NormalizedTime = NPC->CurrentTime / 24.0f;
    Brain->SetNamedInputValue(TEXT("TimeOfDay"), NormalizedTime);
}

EScheduleActivity DetermineActivity(float Time)
{
    if (Time >= 0.0f && Time < 6.0f)
        return EScheduleActivity::Sleep; // Midnight-6 AM
    else if (Time >= 8.0f && Time < 12.0f)
        return EScheduleActivity::Work; // 8 AM-12 PM
    else if (Time >= 12.0f && Time < 13.0f)
        return EScheduleActivity::Eat; // Lunch
    else if (Time >= 13.0f && Time < 17.0f)
        return EScheduleActivity::Work; // 1-5 PM
    else if (Time >= 18.0f && Time < 19.0f)
        return EScheduleActivity::Eat; // Dinner
    else if (Time >= 19.0f && Time < 22.0f)
        return EScheduleActivity::Socialize; // Evening
    else if (Time >= 22.0f || Time < 0.0f)
        return EScheduleActivity::Sleep; // Night
    else
        return EScheduleActivity::Idle;
}</code></pre>

<h2>Step 3: Dialogue Action</h2>

<h3>Action: DA_NPC_Dialogue</h3>

<pre><code>ActionName: "Dialogue"
DisplayName: "Engage in Dialogue"
BaseScore: 90.0
Priority: 85 (very high - interrupts most things)

Considerations:
  1. PlayerRequestsDialogue
     InputName: "PlayerRequestingDialogue"
     ResponseCurve: (0,0) → (1,100)
     Weight: 2.0
     Comment: Player pressed interact
     
  2. DistanceToPlayer
     InputName: "DistanceToPlayer"
     ResponseCurve: (0,100) → (0.1,100) → (0.3,50) → (1,0)
     Weight: 1.5
     Comment: Must be close
     
  3. NotBusy
     InputName: "IsBusy"
     ResponseCurve: (0,100) → (1,0)
     bInvertCurve: true
     Weight: 1.0
     Comment: Don't interrupt important tasks

Momentum: None (player-initiated)
Replace Resistance: 2.0
bInterruptible: false
UnlockTime: 2.0

Executor: BT_NPC_Dialogue</code></pre>

<h3>Dialogue Behavior Tree</h3>

<pre><code>BT_NPC_Dialogue:

Root
└─ Sequence
   ├─ Face Player
   ├─ Play Greeting Animation
   ├─ Start Dialogue System
   │  → Open dialogue UI
   │  → Load NPC dialogue tree
   │  → Wait for dialogue completion
   ├─ Play Farewell Animation
   ├─ Clear Player Request
   └─ Success

Dialogue Integration:
  Start Dialogue System:
    → Get DialogueComponent
    → StartDialogue(NPCDialogueAsset)
    → Set bIsInDialogue = true
    → Wait for OnDialogueEnded event
    
  On Dialogue Ended:
    → Set bIsInDialogue = false
    → Clear PlayerRequestingDialogue input
    → Resume normal behavior</code></pre>

<h2>Step 4: Schedule-Based Actions</h2>

<h3>Action: DA_NPC_Work</h3>

<pre><code>ActionName: "Work"
DisplayName: "Go to Work"
BaseScore: 70.0
Priority: 60

Considerations:
  1. Schedule_Work
     InputName: "Schedule_Work"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.5
     
  2. DistanceFromWorkLocation
     InputName: "DistanceFromWork"
     ResponseCurve: (0,10) → (0.2,100) → (1,100)
     Weight: 1.0
     Comment: Need to go if far

Momentum:
  MaxMomentum: 3.0
  MomentumDecayTime: 10.0

Replace Resistance: 1.3
bInterruptible: true
UnlockTime: 0.0

Executor: BT_NPC_Work
  → Move To Work Location
  → Play Work Animation Loop
  → Wait until schedule changes</code></pre>

<h3>Action: DA_NPC_Sleep</h3>

<pre><code>ActionName: "Sleep"
DisplayName: "Go to Sleep"
BaseScore: 75.0
Priority: 65

Considerations:
  1. Schedule_Sleep
     InputName: "Schedule_Sleep"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.5
     
  2. DistanceFromHome
     InputName: "DistanceFromHome"
     ResponseCurve: (0,10) → (0.2,100) → (1,100)
     Weight: 1.0

Momentum:
  MaxMomentum: 5.0
  MomentumDecayTime: 15.0

Replace Resistance: 1.5
bInterruptible: false (hard to wake)
UnlockTime: 0.0

Executor: BT_NPC_Sleep
  → Move To Home
  → Find Bed
  → Play Sleep Animation
  → Wait until morning</code></pre>

<h3>Action: DA_NPC_Eat</h3>

<pre><code>ActionName: "Eat"
DisplayName: "Get Food"
BaseScore: 72.0
Priority: 63

Considerations:
  1. Schedule_Eat
     InputName: "Schedule_Eat"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.5

Executor: BT_NPC_Eat
  → Find Food Location (tavern, kitchen, etc.)
  → Move To Food Location
  → Play Eat Animation
  → Wait (30 seconds)
  → Success</code></pre>

<h2>Step 5: Idle & Wander Actions</h2>

<h3>Action: DA_NPC_Wander</h3>

<pre><code>ActionName: "Wander"
DisplayName: "Wander Around"
BaseScore: 55.0
Priority: 35

Considerations:
  1. Schedule_Idle OR Schedule_Socialize
     InputName: "Schedule_Idle"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.0
     
  2. NoPlayerNearby
     InputName: "DistanceToPlayer"
     ResponseCurve: (0,0) → (0.3,100) → (1,100)
     Weight: 0.8
     Comment: Don't wander when player nearby

Momentum:
  MaxMomentum: 1.5
  MomentumDecayTime: 3.0

Replace Resistance: 1.0
bInterruptible: true
UnlockTime: 0.0

Executor: BT_NPC_Wander
  → Get Random Point in Radius (1000 units)
  → Move To Point (walking)
  → Look Around
  → Wait (2-5 seconds)
  → Success (loops)</code></pre>

<h3>Action: DA_NPC_IdleActivity</h3>

<pre><code>ActionName: "IdleActivity"
DisplayName: "Perform Idle Activity"
BaseScore: 58.0
Priority: 40

Considerations:
  1. Schedule_Idle
     InputName: "Schedule_Idle"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.0
     
  2. HasIdleActivity
     InputName: "HasNearbyActivity"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.2

Executor: BT_NPC_IdleActivity
  → Find Nearby Activity (bench, barrel, broom, etc.)
  → Move To Activity
  → Perform Activity
    Options:
      - Sit on bench
      - Sweep floor
      - Look at items
      - Read book
      - Craft item
  → Wait (10-30 seconds)
  → Success</code></pre>

<h2>Step 6: Contextual Interactions</h2>

<h3>Player Interaction Detection</h3>

<pre><code>// Service: UService_PlayerInteraction
void UService_PlayerInteraction::TickService(float DeltaTime)
{
    ANPCPawn* NPC = GetNPCPawn();
    
    // Find player
    APawn* Player = GetWorld()->GetFirstPlayerController()->GetPawn();
    if (!Player) return;
    
    // Calculate distance
    float Distance = FVector::Dist(NPC->GetActorLocation(), Player->GetActorLocation());
    float NormalizedDistance = FMath::Clamp(Distance / 5000.0f, 0.0f, 1.0f);
    
    // Publish player proximity
    Brain->SetNamedInputValue(TEXT("DistanceToPlayer"), NormalizedDistance);
    Brain->SetNamedInputValue(TEXT("PlayerNearby"), Distance < 500.0f ? 1.0f : 0.0f);
    
    // Check if player is requesting dialogue
    bool bPlayerRequesting = CheckPlayerInteractInput() && Distance < 200.0f;
    Brain->SetNamedInputValue(TEXT("PlayerRequestingDialogue"), bPlayerRequesting ? 1.0f : 0.0f);
}

bool CheckPlayerInteractInput()
{
    // Check if player pressed interact button while looking at NPC
    // Implement based on your input system
    return bInteractButtonPressed && PlayerLookingAtNPC();
}</code></pre>

<h3>Context Detection</h3>

<pre><code>// Detect contextual situations
void PublishContextualInputs()
{
    // Quest context
    bool bHasQuest = HasQuestForPlayer();
    Brain->SetNamedInputValue(TEXT("HasQuestForPlayer"), bHasQuest ? 1.0f : 0.0f);
    
    // Merchant context
    bool bIsShopOpen = IsShopHoursAndPlayerNearby();
    Brain->SetNamedInputValue(TEXT("ShopOpen"), bIsShopOpen ? 1.0f : 0.0f);
    
    // Danger context
    bool bDangerNearby = DetectNearbyEnemies();
    Brain->SetNamedInputValue(TEXT("DangerNearby"), bDangerNearby ? 1.0f : 0.0f);
    
    // Event context
    bool bEventActive = IsSpecialEventActive();
    Brain->SetNamedInputValue(TEXT("SpecialEvent"), bEventActive ? 1.0f : 0.0f);
}</code></pre>

<h2>Step 7: Flee Behavior</h2>

<h3>Action: DA_NPC_Flee</h3>

<pre><code>ActionName: "Flee"
DisplayName: "Flee from Danger"
BaseScore: 88.0
Priority: 90 (override almost everything)

Considerations:
  1. DangerNearby
     InputName: "DangerNearby"
     ResponseCurve: (0,0) → (1,100)
     Weight: 2.0
     
  2. DistanceToThreat
     InputName: "DistanceToThreat"
     ResponseCurve: (0,100) → (0.3,100) → (1,0)
     bInvertCurve: true
     Weight: 1.5
     Comment: Flee when threat is close

Momentum: None
Replace Resistance: 2.5
bInterruptible: false
UnlockTime: 5.0

Executor: BT_NPC_Flee
  → Play Panic Animation
  → Get Flee Direction (away from threat)
  → Run To Safe Location
  → Hide if possible
  → Wait Until Safe
  → Success</code></pre>

<h2>Step 8: Dialogue Variety</h2>

<h3>Dialogue Context System</h3>

<pre><code>// Return appropriate dialogue based on context
FDialogueAsset* GetContextualDialogue()
{
    // Time-based
    if (CurrentTime >= 6.0f && CurrentTime < 12.0f)
        return MorningDialogue;
    else if (CurrentTime >= 12.0f && CurrentTime < 18.0f)
        return AfternoonDialogue;
    else if (CurrentTime >= 18.0f)
        return EveningDialogue;
    
    // Quest-based
    if (HasQuestForPlayer())
        return QuestDialogue;
    
    // Relationship-based
    if (GetPlayerReputation() > 80)
        return FriendlyDialogue;
    else if (GetPlayerReputation() < 20)
        return UnfriendlyDialogue;
    
    // Default
    return GenericDialogue;
}

Dialogue Responses:
  Morning: "Good morning! Early start today?"
  Afternoon: "Afternoon. Hot day, isn't it?"
  Evening: "Evening. Long day for both of us."
  Quest: "Ah, about that task I mentioned..."
  Friendly: "My friend! Good to see you!"
  Unfriendly: "What do you want?"
  Generic: "Hello there."</code></pre>

<h2>Complete Configuration Summary</h2>

<pre><code>NPC Pawn: BP_VillagerNPC
  HomeLocation: Set in level
  WorkLocation: Set in level
  CurrentTime: 8.0 (8 AM start)
  
Services:
  [0] NPCSchedule (custom - time system)
  [1] PlayerInteraction (custom - proximity)
  [2] ContextDetection (custom - quests, events)
  [3] PerceptionMonitor (danger detection)

Actions (8 total):
  Dialogue (P:85, player-initiated)
  Flee (P:90, danger response)
  Work (P:60, 8 AM-5 PM)
  Sleep (P:65, night time)
  Eat (P:63, meal times)
  Socialize (P:50, evening)
  Wander (P:35, free time)
  IdleActivity (P:40, free time)

Schedule:
  0-6 AM: Sleep
  6-8 AM: Wake, prepare
  8-12 PM: Work
  12-1 PM: Lunch
  1-5 PM: Work
  5-6 PM: Return home
  6-7 PM: Dinner
  7-10 PM: Socialize
  10 PM+: Sleep

Context-Aware:
  Has quest → Quest dialogue
  Shop hours → Merchant mode
  Danger → Flee immediately
  Special event → Event reactions

Result: Believable, interactive NPC</code></pre>

<h2>Next Steps</h2>

<div class="next-steps">
  <a class="button primary" href="#/docs/example-combat-soldier">
    <i data-lucide="crosshair"></i>
    Combat Example
  </a>
  <a class="button" href="#/docs/archetype-guide">
    <i data-lucide="layers"></i>
    Archetype Guide
  </a>
</div>

<h3>Related Examples</h3>
<ul>
  <li><a href="#/docs/example-companion-ai"><i data-lucide="heart"></i> Companion AI</a> - Follower behaviors</li>
  <li><a href="#/docs/example-creature-ai"><i data-lucide="bug"></i> Creature AI</a> - Animal behaviors</li>
  <li><a href="#/docs/action-patterns"><i data-lucide="layers"></i> Action Patterns</a> - Design patterns</li>
  <li><a href="#/docs/tuning"><i data-lucide="sliders"></i> Tuning Guide</a> - Balance NPC behavior</li>
</ul>

<script>lucide.createIcons();</script>
