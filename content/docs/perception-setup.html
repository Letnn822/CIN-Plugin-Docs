<h1>Perception Setup</h1>
<p class="note">Configure advanced perception for your AI agents. Learn how to set up sight, hearing, and damage detection, then integrate it seamlessly with the Utility AI brain.</p>

<div class="page-meta">
  <span class="time"><i data-lucide="clock"></i> 15 minutes</span>
  <span class="difficulty"><i data-lucide="bar-chart-2"></i> Intermediate</span>
</div>

<div class="callout tip">
  <span class="icon"><i data-lucide="lightbulb"></i></span>
  <div>
    <strong>Integration Power:</strong> CIN Plugin automatically bridges Unreal's <code>UAIPerceptionComponent</code> to Utility AI through <code>UService_PerceptionMonitor</code>, publishing 20+ inputs with zero manual work.
  </div>
</div>

<h2>Complete Perception Stack</h2>

<pre><code>Perception System Architecture:
┌──────────────────────────────────────────────┐
│ UAIPerceptionComponent (Engine)              │
│ ├─ AISenseConfig_Sight                       │
│ ├─ AISenseConfig_Hearing                     │
│ └─ AISenseConfig_Damage                      │
└────────────────┬─────────────────────────────┘
                 ▼
┌──────────────────────────────────────────────┐
│ UService_PerceptionMonitor (CIN Plugin)      │
│ ├─ Polls perception for stimuli              │
│ ├─ Tracks stimulus memory                    │
│ ├─ Assesses threat levels                    │
│ └─ Distinguishes allies vs enemies           │
└────────────────┬─────────────────────────────┘
                 ▼
┌──────────────────────────────────────────────┐
│ UtilityBrainComponent (CIN Plugin)           │
│ └─ 20+ auto-published NamedInputs            │
│    ├─ HasKnownEnemy, ThreatLevel             │
│    ├─ NearestEnemyDistance                   │
│    └─ LastKnownEnemyLocation, etc.           │
└────────────────┬─────────────────────────────┘
                 ▼
┌──────────────────────────────────────────────┐
│ Actions Use Inputs for Scoring              │
│ ├─ Attack: scores on HasKnownEnemy          │
│ ├─ TakeCover: scores on ThreatLevel         │
│ └─ Search: scores on LastKnownLocation      │
└──────────────────────────────────────────────┘</code></pre>

<h2>Step 1: Configure AIPerceptionComponent</h2>

<h3>Add to AI Controller</h3>

<p><strong>Blueprint:</strong></p>
<pre><code>BP_YourAIController (AIController)
├─ Add Component: AIPerceptionComponent
└─ Configure senses (see below)</code></pre>

<p><strong>C++:</strong></p>
<pre><code>// YourAIController.h
#include "Perception/AIPerceptionComponent.h"

UPROPERTY(VisibleAnywhere, BlueprintReadOnly)
UAIPerceptionComponent* AIPerception;

// YourAIController.cpp
AYourAIController::AYourAIController()
{
    AIPerception = CreateDefaultSubobject<UAIPerceptionComponent>(TEXT("AIPerception"));
    SetPerceptionComponent(*AIPerception);
}</code></pre>

<h3>Configure Sight Sense</h3>

<p><strong>In AIPerceptionComponent details:</strong></p>

<ol>
  <li>Click <strong>+</strong> on <strong>Senses Config</strong></li>
  <li>Add <strong>AISenseConfig_Sight</strong></li>
  <li>Configure properties:</li>
</ol>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Recommended Value</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Sight Radius</strong></td>
      <td>3000 (combat)<br>5000 (sniper)<br>1500 (melee)</td>
      <td>How far AI can see</td>
    </tr>
    <tr>
      <td><strong>Lose Sight Radius</strong></td>
      <td>Sight Radius + 500</td>
      <td>Hysteresis to prevent flickering</td>
    </tr>
    <tr>
      <td><strong>Peripheral Vision Angle</strong></td>
      <td>90 (human-like)<br>180 (creature)<br>60 (focused)</td>
      <td>Field of view in degrees</td>
    </tr>
    <tr>
      <td><strong>Detection by Affiliation</strong></td>
      <td>✓ Detect Enemies<br>✓ Detect Neutrals<br>□ Detect Friendlies</td>
      <td>What to detect</td>
    </tr>
    <tr>
      <td><strong>Auto Success Range</strong></td>
      <td>500 (close range)</td>
      <td>Always detect within this range</td>
    </tr>
    <tr>
      <td><strong>Max Age</strong></td>
      <td>5.0 seconds</td>
      <td>How long to remember unseen targets</td>
    </tr>
  </tbody>
</table>

<h3>Configure Hearing Sense</h3>

<ol>
  <li>Add <strong>AISenseConfig_Hearing</strong></li>
  <li>Configure properties:</li>
</ol>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Recommended Value</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Hearing Range</strong></td>
      <td>2000 (normal)<br>3000 (enhanced)<br>1000 (poor)</td>
      <td>How far AI can hear</td>
    </tr>
    <tr>
      <td><strong>Detection by Affiliation</strong></td>
      <td>✓ Detect Enemies<br>✓ Detect Neutrals<br>□ Detect Friendlies</td>
      <td>What to hear</td>
    </tr>
    <tr>
      <td><strong>Max Age</strong></td>
      <td>3.0 seconds</td>
      <td>How long to remember sounds</td>
    </tr>
  </tbody>
</table>

<h3>Configure Damage Sense</h3>

<ol>
  <li>Add <strong>AISenseConfig_Damage</strong></li>
  <li>No additional configuration needed</li>
  <li>Automatically detects when AI takes damage</li>
</ol>

<h3>Set Dominant Sense</h3>

<p>In AIPerceptionComponent:</p>
<ul>
  <li><strong>Dominant Sense:</strong> <code>Sight</code> (usually sight is most important)</li>
</ul>

<h2>Step 2: Set Team IDs</h2>

<div class="callout warn">
  <span class="icon"><i data-lucide="alert-triangle"></i></span>
  <div>
    <strong>Critical Step:</strong> Team IDs are required for enemy/ally distinction. Without them, all actors are treated as neutral!
  </div>
</div>

<h3>Implement IGenericTeamAgentInterface</h3>

<p><strong>Blueprint (in Pawn or Controller):</strong></p>

<pre><code>1. Class Settings → Interfaces → Add
   └─ GenericTeamAgentInterface

2. Event Graph → Override Functions
   └─ Get Generic Team Id

3. Implementation:
   Return: Make GenericTeamId
     └─ Team ID: 1 (enemies use 1, 2, 3...)
                 0 (player team)</code></pre>

<p><strong>C++ (in Pawn or Controller):</strong></p>

<pre><code>// YourPawn.h or YourAIController.h
#include "GenericTeamAgentInterface.h"

class AYourPawn : public ACharacter, public IGenericTeamAgentInterface
{
    GENERATED_BODY()
    
public:
    virtual FGenericTeamId GetGenericTeamId() const override;
    
private:
    UPROPERTY(EditAnywhere, Category = "Team")
    uint8 TeamID = 1; // 0=player, 1+=AI teams
};

// YourPawn.cpp
FGenericTeamId AYourPawn::GetGenericTeamId() const
{
    return FGenericTeamId(TeamID);
}</code></pre>

<h3>Team ID Conventions</h3>

<table>
  <thead>
    <tr>
      <th>Team ID</th>
      <th>Use</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>Player team</td>
      <td>Player character, companions</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Enemy team 1</td>
      <td>Main antagonist faction</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Enemy team 2</td>
      <td>Rival faction (also hostile to team 1)</td>
    </tr>
    <tr>
      <td>255</td>
      <td>Neutral</td>
      <td>Civilians, wildlife</td>
    </tr>
  </tbody>
</table>

<h2>Step 3: Add PerceptionMonitor Service</h2>

<p><strong>In your Agent Preset:</strong></p>

<pre><code>DA_YourAI_Preset
└─ Extra Services
   └─ UService_PerceptionMonitor
      ├─ MinInterval: 0.2 (tick 5x/second)
      ├─ StimulusMemoryDuration: 10.0
      ├─ CloseThreatDistance: 500.0
      ├─ MediumThreatDistance: 1500.0
      ├─ UnderFireWindow: 2.0
      ├─ bPublishEnemyInputs: true
      ├─ bPublishAllyInputs: true
      ├─ bPublishThreatInputs: true
      ├─ bPublishSoundInputs: true
      └─ bPublishMemoryInputs: true</code></pre>

<h2>Step 4: Emit Sounds (For Hearing)</h2>

<h3>Blueprint: Report Noise Event</h3>

<pre><code>// When character fires weapon, walks, etc.
Event: On Weapon Fired
  Make Noise
    └─ Loudness: 1.0 (full volume)
    └─ Noise Location: Actor Location
    └─ Max Range: 2000.0
    └─ Instigator: Self
    └─ Tag: "Gunfire"

// Common noise events:
Footsteps: Loudness 0.3, Range 500
Gunfire: Loudness 1.0, Range 2000
Explosion: Loudness 1.0, Range 5000
Door Opening: Loudness 0.5, Range 1000</code></pre>

<h3>C++: Report Noise Event</h3>

<pre><code>#include "Perception/AISense_Hearing.h"

void AYourCharacter::FireWeapon()
{
    // Fire weapon logic...
    
    // Report noise
    UAISense_Hearing::ReportNoiseEvent(
        this,                    // World context
        GetActorLocation(),      // Noise location
        1.0f,                    // Loudness (0-1)
        this,                    // Instigator
        2000.0f,                 // Max range
        FName("Gunfire")         // Tag
    );
}</code></pre>

<h2>Auto-Published Perception Inputs</h2>

<h3>Complete Input Reference</h3>

<table>
  <thead>
    <tr>
      <th>Input Name</th>
      <th>Type</th>
      <th>Range</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>HasKnownEnemy</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Any enemy known (visible or remembered)</td>
    </tr>
    <tr>
      <td><code>EnemyCount</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Number of enemies / 10 (clamped)</td>
    </tr>
    <tr>
      <td><code>HasVisibleEnemy</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Can currently see enemy</td>
    </tr>
    <tr>
      <td><code>VisibleEnemyCount</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Visible enemies / 10 (clamped)</td>
    </tr>
    <tr>
      <td><code>NearestEnemyDistance</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Distance / MaxSightRadius</td>
    </tr>
    <tr>
      <td><code>DistanceToEnemy</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Alias for NearestEnemyDistance</td>
    </tr>
    <tr>
      <td><code>HasLineOfSight</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Clear line of sight to enemy</td>
    </tr>
    <tr>
      <td><code>CanSeeEnemy</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Alias for HasLineOfSight</td>
    </tr>
    <tr>
      <td><code>ThreatLevel</code></td>
      <td>Float</td>
      <td>0-1</td>
      <td>Assessed danger (distance + visibility + recency)</td>
    </tr>
    <tr>
      <td><code>UnderFire</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Took damage within UnderFireWindow</td>
    </tr>
    <tr>
      <td><code>TimeSinceLastSawEnemy</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Seconds / StimulusMemoryDuration</td>
    </tr>
    <tr>
      <td><code>LastKnownEnemyLocationX</code></td>
      <td>World</td>
      <td>Float</td>
      <td>X coordinate of last seen position</td>
    </tr>
    <tr>
      <td><code>LastKnownEnemyLocationY</code></td>
      <td>World</td>
      <td>Float</td>
      <td>Y coordinate of last seen position</td>
    </tr>
    <tr>
      <td><code>LastKnownEnemyLocationZ</code></td>
      <td>World</td>
      <td>Float</td>
      <td>Z coordinate of last seen position</td>
    </tr>
    <tr>
      <td><code>DistanceToLastKnownEnemy</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Distance to memory / MaxSightRadius</td>
    </tr>
    <tr>
      <td><code>HeardSuspiciousSound</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Recently heard enemy sound</td>
    </tr>
    <tr>
      <td><code>HasSuspiciousLocation</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Has location to investigate (sound or memory)</td>
    </tr>
    <tr>
      <td><code>SuspiciousLocationDistance</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Distance to suspicious location</td>
    </tr>
    <tr>
      <td><code>AllyCount</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Nearby allies / 10 (clamped)</td>
    </tr>
    <tr>
      <td><code>NearestAllyDistance</code></td>
      <td>Normalized</td>
      <td>0-1</td>
      <td>Distance to nearest ally</td>
    </tr>
    <tr>
      <td><code>HasAllyNearby</code></td>
      <td>Bool</td>
      <td>0 or 1</td>
      <td>Any ally within detection range</td>
    </tr>
  </tbody>
</table>

<h2>Archetype-Specific Configurations</h2>

<h3>BaseCombat (Standard Combat)</h3>

<pre><code>AIPerception:
  Sight Radius: 3000
  Lose Sight Radius: 3500
  Peripheral Vision: 90°
  Hearing Range: 2000
  
PerceptionMonitor:
  Memory Duration: 10s (remember last position)
  Close Threat: 500 (melee range)
  Medium Threat: 1500 (mid-range combat)
  Publish All: true</code></pre>

<h3>BaseStealth (Investigation AI)</h3>

<pre><code>AIPerception:
  Sight Radius: 2500 (slightly shorter)
  Peripheral Vision: 120° (wider awareness)
  Hearing Range: 3000 (enhanced hearing)
  
PerceptionMonitor:
  Memory Duration: 30s (long memory for investigation)
  Close Threat: 300
  Medium Threat: 1000
  bPublishSoundInputs: true (critical for stealth)</code></pre>

<h3>BaseCreature (Animal/Monster)</h3>

<pre><code>AIPerception:
  Sight Radius: 2000 (shorter range)
  Peripheral Vision: 180° (wide FOV)
  Hearing Range: 1500
  Auto Success Range: 200 (always detect close targets)
  
PerceptionMonitor:
  Memory Duration: 5s (short memory, reactive)
  Close Threat: 400
  Medium Threat: 1200
  Quick reactions to immediate threats</code></pre>

<h3>BaseRanged (Sniper/Archer)</h3>

<pre><code>AIPerception:
  Sight Radius: 5000 (long range)
  Lose Sight Radius: 5500
  Peripheral Vision: 60° (focused)
  Hearing Range: 1500 (less important)
  
PerceptionMonitor:
  Memory Duration: 15s (tracks targets)
  Close Threat: 800 (avoid close combat)
  Medium Threat: 2500 (optimal range)
  Focus on visual tracking</code></pre>

<h2>Common Patterns</h2>

<h3>Pattern: Sight-Based Attack</h3>

<pre><code>Action: Attack
  Considerations:
    - HasVisibleEnemy: 0→0, 1→100 (must see target)
    - NearestEnemyDistance: 0→100, 1→0 (prefer close)
    - AmmoCount: 0→0, 1→80

Result: Only attacks when enemy visible and close</code></pre>

<h3>Pattern: Memory-Based Search</h3>

<pre><code>Action: SearchLastKnownLocation
  Considerations:
    - HasKnownEnemy: 0→0, 1→100 (knows enemy exists)
    - HasVisibleEnemy: 0→100, 1→0 (inverted - lost sight)
    - TimeSinceLastSawEnemy: 0→100, 0.5→50, 1→0

Result: Searches when lost track of enemy recently</code></pre>

<h3>Pattern: Threat-Based Cover</h3>

<pre><code>Action: TakeCover
  Considerations:
    - ThreatLevel: 0→0, 1→100 (reacts to danger)
    - Health: 0→100, 1→0 (more urgent when injured)
    - UnderFire: 0→50, 1→100 (urgent if taking damage)

Result: Takes cover when threatened, especially if injured</code></pre>

<h3>Pattern: Sound Investigation</h3>

<pre><code>Action: InvestigateSound
  Considerations:
    - HeardSuspiciousSound: 0→0, 1→100 (heard something)
    - HasVisibleEnemy: 0→100, 1→0 (don't investigate if see enemy)
    - SuspiciousLocationDistance: 0→100, 1→20 (prefer close sounds)

Result: Investigates sounds when no visible threats</code></pre>

<h2>Debug Visualization</h2>

<h3>Enable Perception Debug</h3>

<p><strong>In PerceptionMonitor service:</strong></p>
<pre><code>bDebugVisualize: true

Draws:
  - Red spheres: Visible enemies
  - Orange spheres: Remembered enemy locations
  - Green spheres: Allies
  - Yellow cones: Sight perception
  - Blue circles: Hearing range</code></pre>

<h3>Gameplay Debugger Perception</h3>

<pre><code>Press ' → 4 (Perception category)

Shows:
  - Perception cones (sight)
  - Hearing circles
  - Perceived actors list
  - Stimulus age
  - Detection state</code></pre>

<h2>Troubleshooting</h2>

<h3>Issue: "AI not detecting enemies"</h3>

<p><strong>Checklist:</strong></p>
<ol>
  <li>✓ AIPerceptionComponent added to controller?</li>
  <li>✓ Sight sense configured with non-zero radius?</li>
  <li>✓ "Detect Enemies" checked in sense config?</li>
  <li>✓ Team IDs set correctly (player=0, enemies=1+)?</li>
  <li>✓ Enemies have collision (can be seen)?</li>
  <li>✓ Line of sight not blocked?</li>
</ol>

<h3>Issue: "Perception inputs always 0"</h3>

<p><strong>Diagnosis:</strong></p>
<ol>
  <li>Service not added → Add PerceptionMonitor to preset</li>
  <li>Service not running → Check Gameplay Debugger active services</li>
  <li>No team ID → Implement IGenericTeamAgentInterface</li>
  <li>AIPerception not detecting → Check previous issue</li>
</ol>

<h3>Issue: "AI detects through walls"</h3>

<p><strong>Solution:</strong></p>
<ul>
  <li>Ensure walls have collision (Block Visibility channel)</li>
  <li>Check "Auto Success Range" (AI always sees within this range)</li>
  <li>Verify sight traces aren't bypassing geometry</li>
</ul>

<h2>Next Steps</h2>

<div class="next-steps">
  <a class="button primary" href="#/docs/squad-setup">
    <i data-lucide="users"></i>
    Squad Coordination
  </a>
  <a class="button" href="#/docs/tuning">
    <i data-lucide="sliders"></i>
    Tuning & Balancing
  </a>
</div>

<h3>Related Topics</h3>
<ul>
  <li><a href="#/docs/service-perception"><i data-lucide="eye"></i> PerceptionMonitor API</a> - Complete reference</li>
  <li><a href="#/docs/stimulus-memory"><i data-lucide="cloud"></i> Stimulus Memory</a> - Advanced memory features</li>
  <li><a href="#/docs/threat-assessment"><i data-lucide="alert-triangle"></i> Threat Assessment</a> - How threat levels calculated</li>
  <li><a href="#/docs/named-inputs"><i data-lucide="list"></i> Named Inputs</a> - All input values</li>
</ul>

<script>lucide.createIcons();</script>
