<h1>Example: Stealth Guard AI</h1>
<p class="note">Complete working example of a stealth guard AI using BaseStealth archetype. Includes patrol routes, investigation behaviors, alert states, and memory-based searching.</p>

<div class="page-meta">
  <span class="time"><i data-lucide="clock"></i> 30 minutes</span>
  <span class="difficulty"><i data-lucide="code"></i> Example</span>
</div>

<div class="callout tip">
  <span class="icon"><i data-lucide="lightbulb"></i></span>
  <div>
    <strong>What You'll Build:</strong> A stealth game guard AI that patrols routes, investigates suspicious sounds, transitions through alert states, searches last known positions, and calls for backup. Uses BaseStealth archetype with stimulus memory.
  </div>
</div>

<h2>Final Result</h2>

<pre><code>Guard AI Behavior:
├─ Patrol: Follow patrol route (AlertLevel: 0)
├─ Investigate: Check suspicious location (AlertLevel: 0.5)
├─ Alert: Enemy spotted, pursue (AlertLevel: 0.8)
├─ Search: Lost enemy, check last known position (AlertLevel: 0.6)
└─ CallBackup: Radio for help when enemy found

Features:
✓ 30-second stimulus memory
✓ 3-tier alert system
✓ Sound investigation
✓ Last known position search
✓ Gradual alert decay
✓ Backup callouts</code></pre>

<h2>Step 1: Create Guard Pawn</h2>

<h3>Blueprint: BP_StealthGuard</h3>

<pre><code>Parent Class: Character

Components:
  + Skeletal Mesh (guard model)
  + AIPerception (UAIPerceptionComponent)
    Senses:
      - AISight (3000 radius, 90° FOV, LoseSight: 2.0s)
      - AIHearing (3000 radius, LOUD sounds)
      - AIDamage
  + CINQuickSetup (UCINQuickSetupComponent)
    AgentType: BaseStealth
    bAutoInitialize: true

Variables:
  + AlertLevel (float): 0.0 // 0=Idle, 0.5=Suspicious, 0.8=Alert, 1.0=Combat
  + SuspiciousLocation (FVector): Zero
  + bHasSuspiciousLocation (bool): false
  + TimeSinceLastSuspicious (float): 0.0
  + PatrolRoute (TArray<AActor*>): Empty // Patrol points
  + CurrentPatrolIndex (int32): 0</code></pre>

<h3>AIController: BP_GuardController</h3>

<pre><code>Parent Class: AAIController

Event OnPossess
  → Set Generic Team ID (2) // Guards team
  → Find Patrol Points in level
  → Store in PatrolRoute array</code></pre>

<h2>Step 2: Configure Actions</h2>

<h3>Action 1: DA_Action_Guard_Patrol</h3>

<pre><code>ActionName: "Patrol"
DisplayName: "Patrol Route"
BaseScore: 40.0
Priority: 0 (fallback)

Considerations:
  1. AlertLevel
     InputName: "AlertLevel"
     ResponseCurve: (0,100) → (0.3,80) → (0.5,20) → (1,0)
     Weight: 1.0
     Comment: Only patrol when calm
     
  2. HasKnownEnemy
     InputName: "HasKnownEnemy"
     ResponseCurve: (0,100) → (1,0)
     bInvertCurve: true
     Weight: 1.0
     Comment: No enemies

Momentum: None
Replace Resistance: 1.0
bInterruptible: true
UnlockTime: -1.0

Executor: Behavior Tree
  BehaviorTree: BT_Guard_Patrol</code></pre>

<h3>Action 2: DA_Action_Guard_Investigate</h3>

<pre><code>ActionName: "Investigate"
DisplayName: "Investigate Suspicious Sound"
BaseScore: 60.0
Priority: 50

Considerations:
  1. HasSuspiciousLocation
     InputName: "HasSuspiciousLocation"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.0
     
  2. AlertLevel
     InputName: "AlertLevel"
     ResponseCurve: (0,0) → (0.5,100) → (1,50)
     Weight: 1.0
     Comment: Most relevant when suspicious
     
  3. TimeSinceSuspicious
     InputName: "TimeSinceSuspicious"
     ResponseCurve: (0,100) → (0.2,80) → (1,0)
     bInvertCurve: true
     Weight: 1.0
     Comment: Fresh sounds more important

Momentum: None
Replace Resistance: 1.5
bInterruptible: true
UnlockTime: 3.0

Executor: Behavior Tree
  BehaviorTree: BT_Guard_Investigate</code></pre>

<h3>Action 3: DA_Action_Guard_Alert</h3>

<pre><code>ActionName: "Alert"
DisplayName: "Pursue Enemy"
BaseScore: 80.0
Priority: 80

Considerations:
  1. HasVisibleEnemy
     InputName: "HasVisibleEnemy"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.0
     
  2. AlertLevel
     InputName: "AlertLevel"
     ResponseCurve: (0,0) → (0.8,100) → (1,100)
     Weight: 1.0
     Comment: High alert state

Momentum: None
Replace Resistance: 2.0 (hard to interrupt pursuit)
bInterruptible: false
UnlockTime: 0.0

Executor: Behavior Tree
  BehaviorTree: BT_Guard_Alert</code></pre>

<h3>Action 4: DA_Action_Guard_Search</h3>

<pre><code>ActionName: "Search"
DisplayName: "Search Last Known Position"
BaseScore: 70.0
Priority: 60

Considerations:
  1. HasKnownEnemy (but not visible)
     InputName: "HasKnownEnemy"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.0
     
  2. HasVisibleEnemy (inverse - don't search if can see)
     InputName: "HasVisibleEnemy"
     ResponseCurve: (0,100) → (1,0)
     bInvertCurve: true
     Weight: 1.0
     
  3. TimeSinceLastSawEnemy
     InputName: "TimeSinceLastSawEnemy"
     ResponseCurve: (0,100) → (0.1,90) → (0.5,50) → (1,10)
     Weight: 1.0
     Comment: Search recent sightings
     
  4. AlertLevel
     InputName: "AlertLevel"
     ResponseCurve: (0,0) → (0.6,100) → (1,80)
     Weight: 1.0

Momentum: None
Replace Resistance: 1.8
bInterruptible: true
UnlockTime: 5.0

Executor: Behavior Tree
  BehaviorTree: BT_Guard_Search</code></pre>

<h3>Action 5: DA_Action_Guard_CallBackup</h3>

<pre><code>ActionName: "CallBackup"
DisplayName: "Radio for Backup"
BaseScore: 55.0
Priority: 70

Considerations:
  1. HasVisibleEnemy
     InputName: "HasVisibleEnemy"
     ResponseCurve: (0,0) → (1,100)
     Weight: 1.0
     
  2. AlertLevel
     InputName: "AlertLevel"
     ResponseCurve: (0,0) → (0.8,50) → (1,100)
     Weight: 1.0

Momentum: None
Replace Resistance: 1.0
bInterruptible: true
UnlockTime: 30.0 (cooldown - don't spam calls)

Executor: Behavior Tree
  BehaviorTree: BT_Guard_CallBackup</code></pre>

<h2>Step 3: Configure Services</h2>

<h3>Service: PerceptionMonitor (Enhanced)</h3>

<pre><code>Configuration:
  StimulusMemoryDuration: 30.0 // Long memory for stealth
  CloseThreatDistance: 800.0
  MediumThreatDistance: 2000.0
  UnderFireWindow: 3.0
  bPublishEnemyInputs: true
  bPublishThreatInputs: true
  bPublishSoundInputs: true // CRITICAL for investigation
  bPublishMemoryInputs: true // CRITICAL for searching
  bDebugVisualize: true</code></pre>

<h3>Service: AlertLevelManager (Custom)</h3>

<pre><code>// Custom service to manage alert state
void UAlertLevelService::TickService(float DeltaTime)
{
    Super::TickService(DeltaTime);
    
    APawn* Owner = GetOwningPawn();
    float CurrentAlert = Owner->AlertLevel;
    
    // Get perception state
    bool HasVisibleEnemy = OwningBrain->GetNamedInputValue(TEXT("HasVisibleEnemy")) > 0.5f;
    bool HasKnownEnemy = OwningBrain->GetNamedInputValue(TEXT("HasKnownEnemy")) > 0.5f;
    bool HeardSound = OwningBrain->GetNamedInputValue(TEXT("HeardSuspiciousSound")) > 0.5f;
    
    // Escalate alert
    if (HasVisibleEnemy)
    {
        CurrentAlert = FMath::Min(1.0f, CurrentAlert + DeltaTime * 2.0f); // Fast escalation
    }
    else if (HasKnownEnemy)
    {
        CurrentAlert = FMath::Min(0.8f, CurrentAlert + DeltaTime * 1.0f); // Medium escalation
    }
    else if (HeardSound)
    {
        CurrentAlert = FMath::Min(0.5f, CurrentAlert + DeltaTime * 0.5f); // Slow escalation
    }
    else
    {
        // Decay alert over time
        CurrentAlert = FMath::Max(0.0f, CurrentAlert - DeltaTime * 0.1f); // Slow decay
    }
    
    Owner->AlertLevel = CurrentAlert;
    OwningBrain->SetNamedInputValue(TEXT("AlertLevel"), CurrentAlert);
}

Add to Brain Services:
  [0] UService_PerceptionMonitor
  [1] UAlertLevelService</code></pre>

<h3>Service: SuspiciousLocationTracker (Custom)</h3>

<pre><code>// Tracks suspicious sound locations
void USuspiciousLocationService::TickService(float DeltaTime)
{
    Super::TickService(DeltaTime);
    
    APawn* Owner = GetOwningPawn();
    
    // Check for suspicious sounds
    float SuspiciousDistance = OwningBrain->GetNamedInputValue(TEXT("SuspiciousLocationDistance"));
    
    if (SuspiciousDistance > 0.01f && SuspiciousDistance < 0.9f)
    {
        // New suspicious sound detected
        FVector SoundLocation = GetSuspiciousSoundLocation(); // From perception
        Owner->SuspiciousLocation = SoundLocation;
        Owner->bHasSuspiciousLocation = true;
        Owner->TimeSinceLastSuspicious = 0.0f;
    }
    
    // Update timer
    if (Owner->bHasSuspiciousLocation)
    {
        Owner->TimeSinceLastSuspicious += DeltaTime;
        
        // Clear old suspicious locations (after 20 seconds)
        if (Owner->TimeSinceLastSuspicious > 20.0f)
        {
            Owner->bHasSuspiciousLocation = false;
        }
    }
    
    // Publish to brain
    OwningBrain->SetNamedInputValue(TEXT("HasSuspiciousLocation"), 
        Owner->bHasSuspiciousLocation ? 1.0f : 0.0f);
    OwningBrain->SetNamedInputValue(TEXT("TimeSinceSuspicious"), 
        Owner->TimeSinceLastSuspicious / 20.0f);
}</code></pre>

<h2>Step 4: Create Behavior Trees</h2>

<h3>BT_Guard_Patrol</h3>

<pre><code>Root
└─ Sequence
   ├─ Get Next Patrol Point
   │  → CurrentPatrolIndex++
   │  → Wrap around if needed
   ├─ Move To Patrol Point
   ├─ Wait (3-5 seconds) // Look around
   ├─ Play Idle Animation
   └─ Finish Execute (Success)</code></pre>

<h3>BT_Guard_Investigate</h3>

<pre><code>Root
└─ Sequence
   ├─ Get Suspicious Location
   ├─ Set AlertLevel = 0.5
   ├─ Move To Suspicious Location
   ├─ Look Around (360° turn)
   ├─ Wait (2 seconds)
   ├─ Selector
   │  ├─ If Enemy Found
   │  │  └─ Set AlertLevel = 0.8
   │  └─ Else
   │     └─ Set AlertLevel = 0.3
   ├─ Clear Suspicious Location
   └─ Finish Execute (Success)</code></pre>

<h3>BT_Guard_Alert</h3>

<pre><code>Root
└─ Sequence
   ├─ Set AlertLevel = 1.0
   ├─ Play Alert Animation/Sound
   ├─ Sequence (Pursuit Loop)
   │  ├─ Get Enemy Location
   │  ├─ Move To Enemy
   │  ├─ Wait (0.5s)
   │  └─ Loop While HasVisibleEnemy
   └─ Finish Execute (Success)</code></pre>

<h3>BT_Guard_Search</h3>

<pre><code>Root
└─ Sequence
   ├─ Get Last Known Enemy Location (from memory)
   ├─ Move To Last Known Position
   ├─ Search Pattern
   │  ├─ Move To Offset (+5m North)
   │  ├─ Wait (1s)
   │  ├─ Move To Offset (+5m East)
   │  ├─ Wait (1s)
   │  ├─ Move To Offset (+5m South)
   │  ├─ Wait (1s)
   │  └─ Move To Offset (+5m West)
   ├─ If No Enemy Found After Pattern
   │  └─ Set AlertLevel = 0.4
   └─ Finish Execute (Success)</code></pre>

<h3>BT_Guard_CallBackup</h3>

<pre><code>Root
└─ Sequence
   ├─ Play Radio Animation
   ├─ Spawn "Backup Called" Widget
   ├─ Broadcast Enemy Location to Squad
   ├─ Wait (2s)
   └─ Finish Execute (Success)</code></pre>

<h2>Step 5: Alert Level System</h2>

<h3>Alert State Transitions</h3>

<pre><code>Alert Level 0.0 (Idle):
  Actions: Patrol
  Perception: Normal FOV (90°)
  Speed: Walk (150 units/s)

Alert Level 0.5 (Suspicious):
  Actions: Investigate
  Perception: Enhanced FOV (120°)
  Speed: Jog (250 units/s)
  
Alert Level 0.8 (Alert):
  Actions: Alert, Search
  Perception: Wide FOV (150°)
  Speed: Run (400 units/s)
  
Alert Level 1.0 (Combat):
  Actions: Alert, CallBackup
  Perception: Max FOV (180°)
  Speed: Sprint (500 units/s)

Escalation:
  Hear Sound → 0.5 (Suspicious)
  See Enemy → 1.0 (Combat)
  Lose Enemy → 0.8 (Alert)
  Find Nothing → Gradual decay to 0.0

Decay Rate: -0.1/second (10 seconds from alert to idle)</code></pre>

<h2>Step 6: Test Scenarios</h2>

<h3>Scenario 1: Normal Patrol</h3>

<pre><code>Setup:
  - Spawn guard with patrol route
  - No player/enemies

Expected:
  → Guard patrols between points
  → AlertLevel = 0.0
  → Waits at each point
  → Cycles through route</code></pre>

<h3>Scenario 2: Sound Investigation</h3>

<pre><code>Setup:
  - Guard on patrol
  - Player makes sound (gunshot, footstep) at distance
  
Expected:
  → Guard hears sound (AIHearing)
  → AlertLevel increases to 0.5
  → Investigate action triggers
  → Guard moves to sound location
  → Looks around
  → If nothing found, AlertLevel decays
  → Returns to patrol</code></pre>

<h3>Scenario 3: Enemy Spotted</h3>

<pre><code>Setup:
  - Guard on patrol
  - Player enters line of sight

Expected:
  → Guard sees player (AISight)
  → AlertLevel jumps to 1.0
  → Alert action triggers
  → Guard pursues player
  → CallBackup triggers (radio animation)
  → Continues pursuit</code></pre>

<h3>Scenario 4: Lost Enemy</h3>

<pre><code>Setup:
  - Guard pursuing player
  - Player breaks line of sight (hides)

Expected:
  → HasVisibleEnemy becomes false
  → Guard stores last known position (memory)
  → Search action triggers
  → Guard moves to last known position
  → Performs search pattern
  → AlertLevel decays to 0.6
  → If not found, continues decay
  → Eventually returns to patrol</code></pre>

<h2>Step 7: Polish and Tuning</h2>

<h3>Tuning Checklist</h3>

<pre><code>□ Adjust perception ranges (sight/hearing)
□ Balance alert escalation rates
□ Fine-tune decay speed (too fast/slow?)
□ Test search pattern effectiveness
□ Verify suspicious sound sensitivity
□ Check patrol route smoothness
□ Test backup call timing
□ Optimize investigation behavior
□ Balance action priorities
□ Profile performance</code></pre>

<h3>Common Adjustments</h3>

<pre><code>Too Easy to Evade:
  - Increase StimulusMemoryDuration (30s → 45s)
  - Slower AlertLevel decay (0.1 → 0.05)
  - Wider search patterns
  
Too Hard to Evade:
  - Decrease perception ranges
  - Faster AlertLevel decay (0.1 → 0.15)
  - Shorter memory (30s → 20s)
  
Investigation Issues:
  - Adjust Investigate BaseScore
  - Tweak TimeSinceSuspicious curve
  - Change suspicious location timeout</code></pre>

<h2>Advanced: Squad Integration</h2>

<pre><code>Add squad coordination:

Components:
  + TacticalMemberComponent
    SquadName: "Guards"
    TeamID: 2
  + TacticalSquadInputProviderComponent

When CallBackup executes:
  → Broadcast to squad
  → All guards receive alert
  → Set their AlertLevel = 0.8
  → Direct them to threat location
  → Converge on player

Result: Coordinated guard response</code></pre>

<h2>Next Steps</h2>

<div class="next-steps">
  <a class="button primary" href="#/docs/example-squad">
    <i data-lucide="users"></i>
    Squad Coordination Example
  </a>
  <a class="button" href="#/docs/example-combat-soldier">
    <i data-lucide="crosshair"></i>
    Combat Soldier Example
  </a>
</div>

<h3>Related Examples</h3>
<ul>
  <li><a href="#/docs/example-squad"><i data-lucide="users"></i> Squad AI</a> - Coordinated guards</li>
  <li><a href="#/docs/example-creature"><i data-lucide="bug"></i> Creature AI</a> - Animal/monster behaviors</li>
  <li><a href="#/docs/example-boss"><i data-lucide="skull"></i> Boss AI</a> - Multi-phase boss</li>
  <li><a href="#/docs/perception-setup"><i data-lucide="eye"></i> Perception Setup</a> - Deep dive into perception</li>
</ul>

<script>lucide.createIcons();</script>
